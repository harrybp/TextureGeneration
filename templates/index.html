<!DOCTYPE html>
<head>
    <script
        src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <style>
    .display-5 {
    font-size: 2.5rem;
    font-weight: 400;
    line-height: 1.2;
    }
    .display-4 {
        font-size: 3.5rem;
        font-weight: 500;
        line-height: 1.2;
    }
    .display-6 {
        font-size: 2.0rem;
        font-weight: 350;
        line-height: 1.2;
    }
    </style>
</head>
<body>
    <div class="jumbotron">
        <div class='container'>
                <h1 class="display-4">Image texture and style synthesis by convolutional neural network</h1>
                <p class="lead">Final Year Project by Harry Bond-Preston</p>
        </div>
        
    </div>
    <div class='container'>
        


        
        <h1 class="display-5">Gaty's Method</h1>
        <p>This method involves optimising on the pixels of a noise image. On each iteration, the image is run through a pre-trained convolutional neural network and the features in each layer of the network are extracted. The loss function used aims to minimise the difference between the features of this image and a source image. The Gram Matrix of each set of features is calculated first in order to exclude spatial information and focus on style.</p>
        <p>Read the original paper <a href='https://arxiv.org/pdf/1505.07376.pdf'>here</a>.</p>
        <div class="row">
            
            <div class='col-sm-4'>
                <div class="progress" id='gatys-progress-container'>
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id='gatys-progress' style="width: 75%"></div>
                </div>
                <img id='img_gatys' src="" class="rounded img-responsive" alt=""  style='width:100%; border:1px solid black'>
            </div>
            <div class="col-sm-8">
                <h2 class="display-6">Generate Texture</h2>
                <div class="form-group">
                    <label for="source_gatys">Source Image</label>
                    <select onchange='show_source_image("gatys")' type="text" class="form-control" id="source_gatys" value="textures/camo.jpg">
                    </select>
                </div>
                <div class="form-group">
                    <label for="lr_gatys">Learning Rate</label>
                    <input type="text" class="form-control" id="lr_gatys" value="0.8">
                </div>
                <div class="form-group">
                    <label for="iter_gatys">Iterations</label>
                    <input type="text" class="form-control" id="iter_gatys" value="400">
                </div>
                <div class="form-inline">
                    <div class="form-check form-check-inline">
                        <input type="checkbox" class="form-check-input" id="tile_check">
                        <label class="form-check-label" for="tile_check">Tileable</label>
                    </div>
                    <button onclick=gatys_button() class="btn btn-primary">Generate</button>
                </div>
                
            </div>
        </div>
        <br><hr />
        <h1 class="display-5">DCGAN Method</h1>
        <p>This method involves training a Deep Convolutional Generational Adversarial Network. The dataset is comprised of randomly cropped 64x64 sections of the source image. The images produced are 64x64. Generation of images from a trained generator is almost instant but training can take hours.</p>
        <p>Read the original paper <a href='https://arxiv.org/pdf/1511.06434.pdf'>here</a>.</p>
        <div class="row">
            
            <div class='col-sm-4'>
                <img id='img-gan-demo' src="" class="rounded img-responsive" alt=""  style='width:100%; border:1px solid black'>
            </div>
            <div class="col-sm-8">
                <h2 class="display-6">Generate Texture</h2>
                <div class="form-group">
                    <label for="source_gatys">Source Generator</label>
                    <select type="text" class="form-control" id="source_generator" value="textures/camo.jpg">
                    </select>
                </div>
                <button onclick=gan_demo_button() class="btn btn-primary">Generate</button>
                
            </div>
            
        </div>
        <br><br>
        <div class="row">
            <div class='col-sm-4'>
                <div class="progress" id='GANs-progress-container'>
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id='GANs-progress' style="width: 75%"></div>
                </div>
                <img id='img_GAN' src="" class="rounded img-responsive" alt=""  style='width:100%; border:1px solid black'>
                
            </div>
            <div class='col-sm-8'>
                
                <h2 class="display-6">Train GAN</h2>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="newOrResume" id="trainNew" value="new" checked onchange=toggleCheckbox()>
                    <label class="form-check-label" for="trainNew">Train New</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="newOrResume" id="resume" value="resume" onchange=toggleCheckbox()> 
                    <label class="form-check-label" for="resume">Resume Training</label>
                </div>
                <div class="form-group" id='generator_select'>
                    <label for="source_gatys">Generator</label>
                    <select type="text" class="form-control" id="source_generator2" value="textures/camo.jpg">
                    </select>
                </div>
                <div class="form-group">
                    <label for="source_GAN">Source Image</label>
                    <select onchange='show_source_image("GAN")' type="text" class="form-control" id="source_GAN" value="textures/camo.jpg">
                    </select>
                </div>
                <div class="form-group">
                    <label for="lr_GAN_train">Learning Rate</label>
                    <input type="text" class="form-control" id="lr_GAN_train" value="0.0002">
                </div>
                <div class="form-group">
                    <label for="iter_GAN_train">Iterations</label>
                    <input type="text" class="form-control" id="iter_GAN_train" value="16">
                </div>
                <div class="form-group">
                    <label for="iter_GAN_train">Generator Name</label>
                    <input type="text" class="form-control" id="name_GAN_train" value="">
                </div>
                <button onclick=GAN_train_button() class="btn btn-primary">Train</button>
            
            </div>
        </div>
        <br><hr />
        
    </div>
</body>

<script>
    var gatys_active = false;
    var GANs_active = false;
    var GAN_target = null;
    var gatys_target = null;

    //Requests gatys method
    function gatys_button(){
        console.log('gatys');
        gatys_active = true;
        var source = $('#source_gatys').val()
        var lr = $('#lr_gatys').val()
        var iterations = $('#iter_gatys').val()
        var tile = $('#tile_check').prop('checked')
        $('#gatys-progress-container').show();
        $('#gatys-progress').attr('aria-valuemax', iterations);
        $('#gatys-progress').attr('aria-valuenow', 0);
        var params = '?source=textures/' + source + '&target=gatys' + '&iterations=' + iterations + '&learning_rate=' + lr + '&tile=' + tile;
        $.get('start_gatys' + params, function( data ) {
            gatys_active = false;
            $('#gatys-progress-container').hide();
            if(tile){
                console.log('tiled')
                window.open('tile_image/' + gatys_target, '_blank');
            }
            });
    }

    function GAN_train_button(){
        var resume = $('#resume').is(':checked')
        var source_generator = $('#source_generator2').val()
        var source = $('#source_GAN').val()
        var lr = $('#lr_GAN_train').val()
        var iterations = $('#iter_GAN_train').val()
        var name = $('#name_GAN_train').val();
        GANs_active = true;
        GAN_target = name;
        var max = parseInt(iterations) * 128 / 16
        $('#GANs-progress-container').show();
        $('#GANs-progress').attr('aria-valuemax', max);
        $('#GANs-progress').attr('aria-valuenow', 0);
        var params = '?source=textures/' + source + '&target=' + name + '&iterations=' + iterations + '&learning_rate=' + lr + '&resume=' + resume + '&generator=' + source_generator;
        $.get('train_GAN' + params, function( data ) {
            GANs_active = false;
            $('#GANs-progress-container').hide();
            });
    }

    //Requests GAN demo
    function gan_demo_button(){
        var source =  $('#source_generator').val()
        $.get('demo_GAN?source=' + source, function( data ) {
            d = new Date();
            $('#img-gan-demo').attr('src', 'image?target=temp/GAN_demo.jpg&time=' +d.getTime());
            });
    }

    //Display the selected source image
    function show_source_image(id){
        var source = $('#source_' + id).val()
        d = new Date();
        $("#img_" + id).attr("src", 'image?target=textures/'+ source + '&time=' +d.getTime());
    }

    //Populate the source image dropdown list
    function get_source_images(){
        $.get('get_source_images', function( data ) {
            for(var i = 0; i < data.length; i++){
                var o = new Option(data[i], data[i]);
                $(o).html(data[i]);
                $("#source_gatys").append(o);
                var p = new Option(data[i], data[i]);
                $(p).html(data[i]);
                $("#source_GAN").append(p);
            }  
            show_source_image('GAN');
            show_source_image('gatys');  
        });
    }

    //Populate the generators dropdown list
    function get_generators(){
        $.get('get_generators', function( data ) {
            for(var i = 0; i < data.length; i++){
                var o = new Option(data[i], data[i]);
                $(o).html(data[i]);
                $("#source_generator").append(o);
                var p = new Option(data[i], data[i]);
                $(p).html(data[i]);
                $("#source_generator2").append(p);
            }  
            gan_demo_button();
        });
    }

    //Get progress for gatys
    function update_progress_gatys(){
        $.get('progress', function( data ) {
            console.log('progress: ' + data);
            var source = $('#source_gatys').val()
            total = $('#gatys-progress').attr('aria-valuemax')
            percent = (parseInt(data+1) / parseInt(total)) * 100
            $('#gatys-progress').attr('aria-valuenow', parseInt(data)).css('width', percent + '%');
        });
    }

    //Get progress for gatys
    function update_progress_GANs(){
        $.get('GAN_progress', function( data ) {
            console.log(data);
            total = $('#GANs-progress').attr('aria-valuemax')
            percent = (parseInt(data+1) / parseInt(total)) * 100
            $('#GANs-progress').attr('aria-valuenow', parseInt(data)).css('width', percent + '%');
      });
    }

    //Get latest image for gatys
    function refresh_GANs(){
        var number = $('#GANs-progress').attr('aria-valuenow')
        var source = $('#source_GAN').val()
        console.log(GAN_target + number)
        d = new Date();
        $("#img_GAN").attr("src", 'image?target=temp/' + GAN_target + number +'.jpg&alt=textures/' + source + '&time=' +d.getTime());
    }

    //Get latest image for gatys
    function refresh_gatys(){
        var number = $('#gatys-progress').attr('aria-valuenow')
        var source = $('#source_gatys').val()
        d = new Date();
        console.log('refresh: ' + number)
        gatys_target = 'gatys' + number;
        $("#img_gatys").attr("src", 'image?target=temp/gatys' + number +'.jpg&alt=textures/' + source + '&time=' +d.getTime());
    }

    var counter = 0;
    setInterval(function(){
        counter++;
        if(gatys_active){
            update_progress_gatys();
            refresh_gatys();
        }
        if(GANs_active && counter > 10){
            counter = 0;
            update_progress_GANs();
            refresh_GANs();
        }
    }, 200)

    function toggleCheckbox(){
        $("#generator_select").toggle()
        console.log($('#resume').is(':checked'))
    }

    $(document).ready(function() {
        $('#gatys-progress-container').hide();
        $('#GANs-progress-container').hide();
        $("#generator_select").hide()
        get_source_images();
        get_generators();
    });
</script>